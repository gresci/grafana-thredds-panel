{"version":3,"sources":["../src/thredds.js"],"names":["moment","mapboxgl","d3","Thredds","ctrl","mapContainer","console","log","createMap","frames","currentFrameIndex","animation","frameIndex","stopAnimation","stepFrame","mapCenterLonLat","parseFloat","panel","mapCenterLongitude","mapCenterLatitude","accessToken","mbApiKey","map","Map","container","style","mapStyle","center","zoom","initialZoom","interactive","userInteractionEnabled","legend","data","needToRedrawFrames","clearFrames","createFrames","startAnimation","forEach","item","getLayer","removeLayer","dataCharacteristics","timeValues","thredds","loaded","createFramesSafely","attemptsLeft","interval","setInterval","clearInterval","time","frameName","wmsUrl","url","parameter","scale_min","scale_max","getSource","addSource","type","tiles","width","height","includes","push","slider","select","id","attr","length","goToIndex","oldFrame","newFrame","newLayer","source","paint","addLayer","text","format","property","resize","panTo","mapCenterMoved","zoomFactor","setZoom","parseInt","remove"],"mappings":";;;;;;;;;;;;;;;AACOA,kB;;AACAC,oB;;AACKC,c;;;;;;;;;;;;;;;;;;;;;AAGSC,mB;AACjB,iCAAYC,IAAZ,EAAkBC,YAAlB,EAAgC;AAAA;;AAC5BC,4BAAQC,GAAR,CAAY,iBAAZ;AACA,yBAAKH,IAAL,GAAYA,IAAZ;AACA,yBAAKC,YAAL,GAAoBA,YAApB;AACA,yBAAKG,SAAL;AACA,yBAAKC,MAAL,GAAc,EAAd,CAL4B,CAKV;AAClB,yBAAKC,iBAAL,GAAyB,CAAzB;AACA,yBAAKC,SAAL,GAAiB,EAAjB;AACH;;;;6CAEQC,U,EACT;AACI,4BAAI,KAAKD,SAAT,EAAoB;AAChB,iCAAKE,aAAL;AACH;AACD,6BAAKH,iBAAL,GAAyBE,aAAa,CAAtC;AACA,6BAAKE,SAAL;AACH;;;gDAEW;AACRR,gCAAQC,GAAR,CAAY,gBAAZ;AACA,4BAAMQ,kBAAkB,CAACC,WAAW,KAAKZ,IAAL,CAAUa,KAAV,CAAgBC,kBAA3B,CAAD,EAAiDF,WAAW,KAAKZ,IAAL,CAAUa,KAAV,CAAgBE,iBAA3B,CAAjD,CAAxB;AACAlB,iCAASmB,WAAT,GAAuB,KAAKhB,IAAL,CAAUa,KAAV,CAAgBI,QAAvC;AACA,6BAAKC,GAAL,GAAW,IAAIrB,SAASsB,GAAb,CAAiB;AACxBC,uCAAW,KAAKnB,YADQ;AAExBoB,mCAAO,4BAA4B,KAAKrB,IAAL,CAAUa,KAAV,CAAgBS,QAF3B;AAGxBC,oCAAQZ,eAHgB;AAIxBa,kCAAMZ,WAAW,KAAKZ,IAAL,CAAUa,KAAV,CAAgBY,WAA3B,CAJkB;AAKxBC,yCAAa,KAAK1B,IAAL,CAAUa,KAAV,CAAgBc;AALL,yBAAjB,CAAX;AAOH;;;mDAEc;AACX,6BAAKC,MAAL,GAAc,EAAd;AACH;;;yDAEoB;AACjB,6BAAKA,MAAL,GAAc,EAAd;AACA,+BAAO,IAAP;AACH;;;sDAEiB;AACd,4BAAMC,OAAO,KAAK7B,IAAL,CAAU6B,IAAvB;AACA,4BAAI,KAAKC,kBAAL,CAAwBD,IAAxB,CAAJ,EAAmC;AAC/B3B,oCAAQC,GAAR,CAAY,oBAAZ;AACA,iCAAKM,aAAL;AACA,iCAAKsB,WAAL;AACA,iCAAKC,YAAL,CAAkBH,IAAlB;AACA;AACA,iCAAKI,cAAL;AACH;AACJ;;;kDAEa;AAAA;;AACV,6BAAK5B,MAAL,CAAY6B,OAAZ,CAAoB,UAACC,IAAD,EAAU;AAC1B,gCAAI,MAAKjB,GAAL,CAASkB,QAAT,CAAkB,OAAOD,IAAzB,CAAJ,EACI,MAAKjB,GAAL,CAASmB,WAAT,CAAqB,OAAOF,IAA5B;AACP,yBAHD;AAIA,6BAAK9B,MAAL,GAAc,EAAd;AACH;;;mDAEc;AAAA;;AACXH,gCAAQC,GAAR,CAAY,cAAZ;AACA,4BAAI,CAAC,KAAKH,IAAL,CAAUsC,mBAAV,CAA8BC,UAAnC,EAA+C;AAC3CrC,oCAAQC,GAAR,CAAY,sBAAZ;AACA;AACH;;AAED,4BAAI,CAAC,KAAKH,IAAL,CAAUwC,OAAf,EAAwB;AACpBtC,oCAAQC,GAAR,CAAY,iBAAZ;AACA;AACH;;AAED,4BAAI,KAAKe,GAAL,CAASuB,MAAT,EAAJ,EAAuB;AACnB,iCAAKC,kBAAL;AACH,yBAFD,MAEO;AACHxC,oCAAQC,GAAR,CAAY,yCAAZ;AACA;AACA;AACA;AACA,gCAAIwC,eAAe,EAAnB;AACA,gCAAMC,WAAWC,YAAY,YAAM;AAC/B3C,wCAAQC,GAAR,CAAY,2BAAZ;AACA,oCAAI,OAAKe,GAAL,CAASuB,MAAT,EAAJ,EAAuB;AACnB,2CAAKC,kBAAL;AACAI,kDAAcF,QAAd;AACH,iCAHD,MAGO;AACH1C,4CAAQC,GAAR,CAAY,4CAAZ;AACA,wCAAI,EAAEwC,YAAF,IAAkB,CAAtB,EAAyB;AACrBG,sDAAcF,QAAd;AACH;AACJ;AACJ,6BAXgB,EAWd,GAXc,CAAjB;AAYH;AACJ;;;yDAEoB;AAAA;;AACjB;AACA;AACA,6BAAK5C,IAAL,CAAUsC,mBAAV,CAA8BC,UAA9B,CAAyCL,OAAzC,CAAiD,UAACa,IAAD,EAAU;AACvD;AACA;AACA,gCAAMC,YAAY,OAAOD,IAAzB;AACA,gCAAME,SAAY,OAAKjD,IAAL,CAAUa,KAAV,CAAgB2B,OAAhB,CAAwBU,GAApC,gBAAkD,OAAKlD,IAAL,CAAUa,KAAV,CAAgB2B,OAAhB,CAAwBW,SAA1E,0BAAwGJ,IAAxG,kEAAyK,OAAK/C,IAAL,CAAUa,KAAV,CAAgB2B,OAAhB,CAAwBY,SAAjM,SAA8M,OAAKpD,IAAL,CAAUa,KAAV,CAAgB2B,OAAhB,CAAwBa,SAAtO,4JAAN;AACA;AACA,gCAAI,OAAKnC,GAAT,EAAc;AACV,oCAAI,CAAC,OAAKA,GAAL,CAASoC,SAAT,CAAmB,OAAOP,IAA1B,CAAL,EACI,OAAK7B,GAAL,CAASqC,SAAT,CAAmB,OAAOR,IAA1B,EAAgC;AAC5BS,0CAAM,QADsB;AAE5BC,2CAAO,CAACR,MAAD,CAFqB;AAG5BS,2CAAO,GAHqB;AAI5BC,4CAAQ;AAJoB,iCAAhC;AAMP;;AAED,gCAAG,CAAC,OAAKtD,MAAL,CAAYuD,QAAZ,CAAqBb,IAArB,CAAJ,EACI,OAAK1C,MAAL,CAAYwD,IAAZ,CAAiBd,IAAjB;AACP,yBAlBD;;AAoBA;AACA,4BAAMe,SAAShE,GAAGiE,MAAH,CAAU,UAAU,KAAK/D,IAAL,CAAUa,KAAV,CAAgBmD,EAA1B,GAA+B,SAAzC,EACVC,IADU,CACL,KADK,EACE,CADF,EAEVA,IAFU,CAEL,KAFK,EAEG,KAAK5D,MAAL,CAAY6D,MAAZ,GAAoB,CAFvB,CAAf;AAIH;;;qDAGgB;AAAA;;AACb,4BAAI,KAAK3D,SAAT,EAAoB;AAChB,iCAAKE,aAAL;AACH;;AAED,6BAAKF,SAAL,GAAiBsC,YAAY,YAAM;AAC/B,mCAAKnC,SAAL;AACH,yBAFgB,EAEd,IAFc,CAAjB;AAGH;;;oDAEe;AACZoC,sCAAc,KAAKvC,SAAnB;AACA,6BAAKA,SAAL,GAAiB,IAAjB;AACH;;;qDAEgB;AACbuC,sCAAc,KAAKvC,SAAnB;AACA;AACH;;;8CAES4D,S,EAAW;AACjBjE,gCAAQC,GAAR,CAAY,WAAZ,EAAyB,KAAKE,MAAL,CAAY6D,MAArC,EAA6C,KAAK5D,iBAAlD;AACA,4BAAI,CAAC,KAAKY,GAAV,EAAe;AACX;AACH;AACD,4BAAI,KAAKb,MAAL,CAAY6D,MAAZ,KAAuB,CAA3B,EAA8B;AAC1B;AACA;AACH;AACD,4BAAME,WAAW,OAAO,KAAK/D,MAAL,CAAY,KAAKC,iBAAjB,CAAxB;;AAEA,4BAAG,CAAC6D,SAAD,IAAcA,cAAc,CAA/B,EAAkC;AAC9B,iCAAK7D,iBAAL,IAA0B,CAA1B;AACH,yBAFD,MAEO;AACH,iCAAKA,iBAAL,GAAyB6D,SAAzB;AACH;AACD,4BAAI,KAAK7D,iBAAL,IAA0B,KAAKD,MAAL,CAAY6D,MAA1C,EAAkD;AAC9C,iCAAK5D,iBAAL,GAAyB,CAAzB;AACH;AACD,4BAAM+D,WAAW,OAAO,KAAKhE,MAAL,CAAY,KAAKC,iBAAjB,CAAxB;;AAEAJ,gCAAQC,GAAR,CAAYkE,QAAZ,EAAsBD,QAAtB;AACA,4BAAG,KAAKlD,GAAL,CAASkB,QAAT,CAAkBgC,QAAlB,CAAH,EAAgC;AAC5B,iCAAKlD,GAAL,CAASmB,WAAT,CAAqB+B,QAArB;AACH;AACD,4BAAME,WAAW;AACbN,gCAAIK,QADS;AAEbb,kCAAM,QAFO;AAGbe,oCAAQF,QAHK;AAIbG,mCAAO;AACH,kDAAkB;AADf;AAJM,yBAAjB;AAQA,6BAAKtD,GAAL,CAASuD,QAAT,CAAkBH,QAAlB;AACA;AACA;;AAEA;AACAxE,2BAAGiE,MAAH,CAAU,UAAU,KAAK/D,IAAL,CAAUa,KAAV,CAAgBmD,EAA1B,GAA+B,OAAzC,EAAkDU,IAAlD,CAAuD9E,OAAO,KAAKS,MAAL,CAAY,KAAKC,iBAAjB,CAAP,EAA4CqE,MAA5C,CAAmD,kBAAnD,CAAvD;AACA;AACA7E,2BAAGiE,MAAH,CAAU,UAAU,KAAK/D,IAAL,CAAUa,KAAV,CAAgBmD,EAA1B,GAA+B,SAAzC,EAAoDY,QAApD,CAA6D,OAA7D,EAAsE,KAAKtE,iBAA3E;AACH;;;6CAEQ;AACL,6BAAKY,GAAL,CAAS2D,MAAT;AACH;;;qDAEgB;AACb,6BAAK3D,GAAL,CAAS4D,KAAT,CAAe,CAAClE,WAAW,KAAKZ,IAAL,CAAUa,KAAV,CAAgBC,kBAA3B,CAAD,EAAiDF,WAAW,KAAKZ,IAAL,CAAUa,KAAV,CAAgBE,iBAA3B,CAAjD,CAAf;AACA,6BAAKf,IAAL,CAAU+E,cAAV,GAA2B,KAA3B;AACH;;;4CAEOC,U,EAAY;AAChB,6BAAK9D,GAAL,CAAS+D,OAAT,CAAiBC,SAASF,UAAT,EAAqB,EAArB,CAAjB;AACH;;;6CAEQ;AACL,4BAAI,KAAK9D,GAAT,EAAc;AACV,iCAAKA,GAAL,CAASiE,MAAT;AACH;AACD,6BAAKjE,GAAL,GAAW,IAAX;AACH;;;;;;+BAjNgBnB,O","file":"thredds.js","sourcesContent":["/* eslint-disable id-length, no-unused-vars */\nimport moment from 'moment';\nimport mapboxgl from './libs/mapbox-gl';\nimport * as d3 from './libs/d3';\n/* eslint-disable id-length, no-unused-vars */\n\nexport default class Thredds {\n    constructor(ctrl, mapContainer) {\n        console.log('NEW constructor')\n        this.ctrl = ctrl;\n        this.mapContainer = mapContainer;\n        this.createMap();\n        this.frames = []; // list of timestamps\n        this.currentFrameIndex = 0;\n        this.animation = {};\n    }\n\n    setFrame(frameIndex)\n    {\n        if (this.animation) {\n            this.stopAnimation();\n        }\n        this.currentFrameIndex = frameIndex - 1;\n        this.stepFrame();\n    }\n\n    createMap() {\n        console.log('rebuilding map');\n        const mapCenterLonLat = [parseFloat(this.ctrl.panel.mapCenterLongitude), parseFloat(this.ctrl.panel.mapCenterLatitude)];\n        mapboxgl.accessToken = this.ctrl.panel.mbApiKey;\n        this.map = new mapboxgl.Map({\n            container: this.mapContainer,\n            style: 'mapbox://styles/mapbox/' + this.ctrl.panel.mapStyle,\n            center: mapCenterLonLat,\n            zoom: parseFloat(this.ctrl.panel.initialZoom),\n            interactive: this.ctrl.panel.userInteractionEnabled\n        });\n    }\n\n    createLegend() {\n        this.legend = {};\n    }\n\n    needToRedrawFrames() {\n        this.legend = {};\n        return true;\n    }\n\n    drawLayerFrames() {\n        const data = this.ctrl.data;\n        if (this.needToRedrawFrames(data)) {\n            console.log('needToRedrawFrames')\n            this.stopAnimation();\n            this.clearFrames();\n            this.createFrames(data);\n            // this.setFrame(0);\n            this.startAnimation();\n        }\n    }\n\n    clearFrames() {\n        this.frames.forEach((item) => {\n            if (this.map.getLayer('f-' + item))\n                this.map.removeLayer('f-' + item);\n        });\n        this.frames = [];\n    }\n\n    createFrames() {\n        console.log('createFrames')\n        if (!this.ctrl.dataCharacteristics.timeValues) {\n            console.log('no series to display');\n            return;\n        }\n\n        if (!this.ctrl.thredds) {\n            console.log('no thredds data');\n            return;\n        }\n\n        if (this.map.loaded()) {\n            this.createFramesSafely();\n        } else {\n            console.log('no geo source in map. maybe not loaded?');\n            // this is stupid to use setInterval.\n            // but mapbox doesn't seem to have a on-source-loaded event that reliably works\n            // for this purpose.\n            let attemptsLeft = 10;\n            const interval = setInterval(() => {\n                console.log('waited for layer to load.');\n                if (this.map.loaded()) {\n                    this.createFramesSafely();\n                    clearInterval(interval);\n                } else {\n                    console.log('still no geo source. try refresh manually?');\n                    if (--attemptsLeft <= 0) {\n                        clearInterval(interval);\n                    }\n                }\n            }, 500);\n        }\n    }\n\n    createFramesSafely() {\n        // console.log('createFramesSafely')\n        // console.log('createFramesSafely',this.ctrl.dataCharacteristics.timeValues)\n        this.ctrl.dataCharacteristics.timeValues.forEach((time) => {\n            // console.log(time)\n            // console.log(this.ctrl.panel.thredds)\n            const frameName = 'f-' + time;\n            const wmsUrl = `${this.ctrl.panel.thredds.url}?LAYERS=${this.ctrl.panel.thredds.parameter}&ELEVATION=0&TIME=${time}&TRANSPARENT=true&STYLES=boxfill%2Fsst_36&COLORSCALERANGE=${this.ctrl.panel.thredds.scale_min},${this.ctrl.panel.thredds.scale_max}&NUMCOLORBANDS=80&LOGSCALE=false&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&FORMAT=image%2Fpng&SRS=EPSG%3A3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256`;\n            // console.log('wmsUrl', wmsUrl);\n            if (this.map) {\n                if (!this.map.getSource('f-' + time))\n                    this.map.addSource('f-' + time, {\n                        type: 'raster',\n                        tiles: [wmsUrl],\n                        width: 256,\n                        height: 256\n                    });\n            }\n\n            if(!this.frames.includes(time))\n                this.frames.push(time);\n        });\n\n        // get slider component, set min/max/value\n        const slider = d3.select('#map_' + this.ctrl.panel.id + '_slider')\n            .attr('min', 0)\n            .attr('max', (this.frames.length -1))\n        ;\n    }\n\n\n    startAnimation() {\n        if (this.animation) {\n            this.stopAnimation();\n        }\n\n        this.animation = setInterval(() => {\n            this.stepFrame();\n        }, 3000);\n    }\n\n    stopAnimation() {\n        clearInterval(this.animation);\n        this.animation = null;\n    }\n\n    pauseAnimation() {\n        clearInterval(this.animation);\n        // this.animation = null;\n    }\n\n    stepFrame(goToIndex) {\n        console.log('stepFrame', this.frames.length, this.currentFrameIndex)\n        if (!this.map) {\n            return;\n        }\n        if (this.frames.length === 0) {\n            // console.log('skipping animation: no frames');\n            return;\n        }\n        const oldFrame = 'f-' + this.frames[this.currentFrameIndex];\n\n        if(!goToIndex && goToIndex !== 0) {\n            this.currentFrameIndex += 1;\n        } else {\n            this.currentFrameIndex = goToIndex;\n        }\n        if (this.currentFrameIndex >= this.frames.length) {\n            this.currentFrameIndex = 0;\n        }\n        const newFrame = 'f-' + this.frames[this.currentFrameIndex];\n\n        console.log(newFrame, oldFrame)\n        if(this.map.getLayer(oldFrame)) {\n            this.map.removeLayer(oldFrame);\n        }\n        const newLayer = {\n            id: newFrame,\n            type: 'raster',\n            source: newFrame,\n            paint: {\n                \"raster-opacity\": 1,\n            },\n        }\n        this.map.addLayer(newLayer);\n        // this.map.setPaintProperty(newFrame, 'raster-opacity', 1);\n        // this.map.setPaintProperty(oldFrame, 'raster-opacity', 0);\n\n        // set time string in legend\n        d3.select('#map_' + this.ctrl.panel.id + '_date').text(moment(this.frames[this.currentFrameIndex]).format('DD-MM-YYYY HH:mm'));\n        // set slider position to indicate time-location\n        d3.select('#map_' + this.ctrl.panel.id + '_slider').property('value', this.currentFrameIndex);\n    }\n\n    resize() {\n        this.map.resize();\n    }\n\n    panToMapCenter() {\n        this.map.panTo([parseFloat(this.ctrl.panel.mapCenterLongitude), parseFloat(this.ctrl.panel.mapCenterLatitude)]);\n        this.ctrl.mapCenterMoved = false;\n    }\n\n    setZoom(zoomFactor) {\n        this.map.setZoom(parseInt(zoomFactor, 10));\n    }\n\n    remove() {\n        if (this.map) {\n            this.map.remove();\n        }\n        this.map = null;\n    }\n}\n"]}